name: Sync with upstream moltworker

on:
  schedule:
    - cron: '0 14 * * 1,4'  # Mon & Thu at 6am PT
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Fetch upstream
        run: |
          git fetch origin main
          git remote add upstream https://github.com/cloudflare/moltworker.git || true
          git fetch upstream main
          
      - name: Check sync status
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          echo "Commits behind upstream: $BEHIND"
          
      - name: Create sync branch and PR
        if: steps.check.outputs.behind > 0
        run: |
          git checkout -B sync/upstream
          git merge upstream/main --no-edit
          git push -f origin sync/upstream
          
      - name: Create Pull Request
        if: steps.check.outputs.behind > 0
        uses: peter-evans/create-pull-request@v5
        with:
          branch: sync/upstream
          title: "ðŸ”„ Sync with cloudflare/moltworker (${{ steps.check.outputs.behind }} commits)"
          body: |
            Automated sync from upstream cloudflare/moltworker.
            
            Review changes and merge when ready.
          labels: upstream-sync
